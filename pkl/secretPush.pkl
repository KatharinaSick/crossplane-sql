amends "goTemplate.pkl"

step = "secret-push-store"
delimLeft = "[["
delimRight = "]]"
templateVar = """
    [[ if and .observed.composite.resource.spec.parameters.secrets.storeName .observed.composite.resource.spec.parameters.secrets.pushToStore ]]
    ---
    apiVersion: kubernetes.crossplane.io/v1alpha2
    kind: Object
    metadata:
      name: [[ $.observed.composite.resource.spec.id ]]-secret-push-store
      annotations:
        gotemplating.fn.crossplane.io/composition-resource-name: [[ $.observed.composite.resource.spec.id ]]-secret-push-store
    spec:
      providerConfigRef:
        name: [[ $.observed.composite.resource.spec.id ]]-sql
      forProvider:
        manifest:
          apiVersion: external-secrets.io/v1alpha1
          kind: PushSecret
          metadata:
            name: [[ $.observed.composite.resource.spec.id ]]
            namespace: [[ $.observed.composite.resource.spec.claimRef.namespace ]]
          spec:
            deletionPolicy: Delete
            refreshInterval: 1h
            secretStoreRefs:
              - name: [[ $.observed.composite.resource.spec.parameters.secrets.storeName ]]
                kind: ClusterSecretStore
            selector:
              secret:
                name: [[ $.observed.composite.resource.spec.id ]]
            template:
              data:
                endpoint: |
                  {
                    "endpoint": "{{ .endpoint }}",
                    "port": "{{ .port }}",
                    "username": "{{ .username }}",
                    "password": "{{ .password }}"[[ range .observed.composite.resource.spec.parameters.databases ]],
                    "conn-[[ . ]]": "host={{ .endpoint }} user={{ .username }} password={{ .password }} port={{ .port }} connect_timeout=10 database=[[ . ]]"[[ end ]]
                  }
            data:
              - match:
                  secretKey: endpoint
                  remoteRef:
                    remoteKey: [[ $.observed.composite.resource.spec.id ]]
    [[ end ]]
    """
